/* eslint-disable */
// @ts-nocheck
'use client';

import React, { useState, useCallback, useRef } from "react";
import { useRouter } from 'next/navigation';
import { useSajuStore } from '@/lib/store';
import html2canvas from 'html2canvas';
import { useConnection, useWallet } from '@solana/wallet-adapter-react';
import { WalletMultiButton } from '@solana/wallet-adapter-react-ui';

import { calculateSaju } from "@/lib/saju-engine";
import { SajuData } from "@/types";
import ShareCard from '@/components/share/ShareCard';
import { mintSajuNFT } from "@/lib/solana/mintSajuNFT";

// Components
import { BottomSheet } from "@/components/ui/BottomSheet";
import ResultPage from "./ResultPage";

// Data & Utils
import { SIJIN, CITIES, GAN_NAMES, ZHI_NAMES } from "@/lib/saju-data";
import { getDaysInMonth } from "@/lib/utils";

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì‚¬ì£¼ ê³„ì‚° ì–´ëŒ‘í„° (Real Engine) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcSajuReal(y: number, m: number, d: number, sijinKey: string | null, gender: string) {
    // 1. Call Real Engine
    const birthTime = sijinKey && sijinKey !== 'unknown'
        ? SIJIN.find(s => s.key === sijinKey)?.time.split('~')[0].trim() || "12:00"
        : "12:00";
    const [hStr, mStr] = birthTime.split(':');
    const hour = parseInt(hStr, 10) || 12;
    const minute = parseInt(mStr, 10) || 0;

    const data = calculateSaju(
        y, m, d, hour, minute,
        gender === 'male' ? 'male' : 'female',
        'solar'
    );

    // Construct valid SajuData for ShareCard/Store
    const sajuData: SajuData = {
        birthDate: `${y}-${m}-${d}`,
        birthTime: birthTime,
        gender: gender as 'male' | 'female',
        fourPillars: {
            year: data.fourPillars.year,
            month: data.fourPillars.month,
            day: data.fourPillars.day,
            hour: data.fourPillars.hour
        },
        dayMaster: typeof data.dayMaster === 'string' ? data.dayMaster : (data.dayMaster as any)?.name || "Unknown",
        fiveElements: data.fiveElements,
        aiResult: {
            headline: data.interpretation.dominanceMsg,
            threeLineSummary: data.interpretation.personalityKeywords,
            personality: "", career: "", relationship: "", health: "",
            yearFortune2026: "", luckyItems: { color: "", number: 0, direction: "" }, advice: ""
        },
        sajuInterpretation: {
            dominanceMsg: data.interpretation.dominanceMsg,
            personalityKeywords: data.interpretation.personalityKeywords
        },
        daewoon: data.daewoon ? {
            startAge: data.daewoon.startAge,
            cycles: data.daewoon.cycles.map(c => ({
                startAge: c.startAge,
                endAge: c.endAge,
                ganZhi: c.ganZhi,
                tenGod: c.tenGod,
                unseong: c.unseong
            }))
        } : undefined
    };

    const mapPillar = (p: any) => ({
        stem: p.heavenlyStem,
        stemName: GAN_NAMES[p.heavenlyStem] || "ì²œê°„",
        stemElement: p.element || "ëª©",
        branch: p.earthlyBranch,
        branchName: ZHI_NAMES[p.earthlyBranch] || "ì§€ì§€",
        branchElement: "í† ",
        tenGod: p.tenGod || "", // "ë¹„ê²¬/í¸ì¬" form
        unseong: p.unseong || "" // "ì¥ìƒ" form
    });

    const pillars = {
        year: mapPillar(data.fourPillars.year),
        month: mapPillar(data.fourPillars.month),
        day: mapPillar(data.fourPillars.day),
        hour: mapPillar(data.fourPillars.hour),
    };

    // Fix branch elements manually as mapPillar above was simplified
    const ZHI_ELS: Record<string, string> = {
        'å­': 'ìˆ˜', 'äº¥': 'ìˆ˜', 'å¯…': 'ëª©', 'å¯': 'ëª©', 'å·³': 'í™”', 'åˆ': 'í™”', 'ç”³': 'ê¸ˆ', 'é…‰': 'ê¸ˆ', 'è¾°': 'í† ', 'æˆŒ': 'í† ', 'ä¸‘': 'í† ', 'æœª': 'í† '
    };
    pillars.year.branchElement = ZHI_ELS[data.fourPillars.year.earthlyBranch] || 'í† ';
    pillars.month.branchElement = ZHI_ELS[data.fourPillars.month.earthlyBranch] || 'í† ';
    pillars.day.branchElement = ZHI_ELS[data.fourPillars.day.earthlyBranch] || 'í† ';
    pillars.hour.branchElement = ZHI_ELS[data.fourPillars.hour.earthlyBranch] || 'í† ';

    // Counts
    const counts: any = { ëª©: 0, í™”: 0, í† : 0, ê¸ˆ: 0, ìˆ˜: 0 };
    if (data.fiveElements?.scores) {
        counts['ëª©'] = data.fiveElements.scores.wood;
        counts['í™”'] = data.fiveElements.scores.fire;
        counts['í† '] = data.fiveElements.scores.earth;
        counts['ê¸ˆ'] = data.fiveElements.scores.metal;
        counts['ìˆ˜'] = data.fiveElements.scores.water;
    }

    // Generate Lucky Items based on Dominant Element (Deterministic)
    const domEl = data.fiveElements?.dominant || 'Wood';
    const luckyMap: Record<string, any> = {
        'Tree': { color: 'Green', hex: '#22c55e', number: 3, direction: 'East' },
        'Fire': { color: 'Red', hex: '#ef4444', number: 7, direction: 'South' },
        'Earth': { color: 'Yellow', hex: '#eab308', number: 5, direction: 'Center' },
        'Metal': { color: 'White', hex: '#e2e8f0', number: 9, direction: 'West' },
        'Water': { color: 'Black', hex: '#3b82f6', number: 1, direction: 'North' },
        'Unknown': { color: 'Purple', hex: '#a855f7', number: 8, direction: 'North' } // Fallback
    };
    const lucky = luckyMap[domEl] || luckyMap['Unknown'];

    // 6. Dynamic Interpretation Logic
    const weakEl = data?.fiveElements?.lacking || 'Water';

    const ADVICE_DB: any = {
        'Tree': {
            career: { title: "ì°½ì˜ì™€ ê¸°íš", keywords: ["ê¸°íš", "êµìœ¡", "ì˜ˆìˆ "], desc: "ìƒˆë¡œìš´ ê²ƒì„ ì‹œì‘í•˜ê³  ë»—ì–´ë‚˜ê°€ëŠ” ê¸°ìš´ì´ ê°•í•©ë‹ˆë‹¤." },
            health: { organs: ["ê°„", "ë‹´ë‚­", "ì‹ ê²½ê³„"], activities: ["ì‚°ë¦¼ìš•", "ìŠ¤íŠ¸ë ˆì¹­"] }
        },
        'Fire': {
            career: { title: "í‘œí˜„ê³¼ ì—´ì •", keywords: ["ë°©ì†¡", "ì˜ˆìˆ ", "ì˜ì—…"], desc: "ìì‹ ì„ ë“œëŸ¬ë‚´ê³  í™•ì‚°ì‹œí‚¤ëŠ” ì—ë„ˆì§€ê°€ ë„˜ì¹©ë‹ˆë‹¤." },
            health: { organs: ["ì‹¬ì¥", "ì†Œì¥", "ì‹œë ¥"], activities: ["ìœ ì‚°ì†Œ ìš´ë™", "ëª…ìƒ"] }
        },
        'Earth': {
            career: { title: "ì‹ ë¢°ì™€ ì¤‘ì¬", keywords: ["ë¶€ë™ì‚°", "ì´ë¬´", "ë†ì—…"], desc: "í¬ìš©ë ¥ê³¼ ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” ë¦¬ë”ì‹­ì´ ìˆìŠµë‹ˆë‹¤." },
            health: { organs: ["ìœ„ì¥", "ë¹„ì¥", "ì†Œí™”ê¸°"], activities: ["ë§¨ë°œ ê±·ê¸°", "ê·œì¹™ì  ì‹ì‚¬"] }
        },
        'Metal': {
            career: { title: "ê²°ë‹¨ê³¼ ì›ì¹™", keywords: ["ê¸ˆìœµ", "êµ°ê²€ê²½", "ê¸°ìˆ "], desc: "ì •í™•í•˜ê³  ë§ºê³  ëŠìŒì´ í™•ì‹¤í•œ ë¶„ì•¼ê°€ ì–´ìš¸ë¦½ë‹ˆë‹¤." },
            health: { organs: ["í", "ëŒ€ì¥", "í”¼ë¶€"], activities: ["ë“±ì‚°", "í”¼ë¶€ ë³´ìŠµ"] }
        },
        'Water': {
            career: { title: "ì§€í˜œì™€ ìœ ì—°", keywords: ["ìœ í†µ", "ë¬´ì—­", "ì—°êµ¬"], desc: "ì§€í˜œë¡­ê³  ìƒí™© ëŒ€ì²˜ ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ íë¥´ëŠ” ë¬¼ê³¼ ê°™ìŠµë‹ˆë‹¤." },
            health: { organs: ["ì‹ ì¥", "ë°©ê´‘", "ìƒì‹ê¸°"], activities: ["ë°˜ì‹ ìš•", "ìˆ˜ì˜"] }
        },
        'Unknown': { // Fallback
            career: { title: "ë‹¤ì¬ë‹¤ëŠ¥", keywords: ["ììœ ì—…", "í”„ë¦¬ëœì„œ"], desc: "ë‹¤ì–‘í•œ ë¶„ì•¼ì— ì ì‘ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤." },
            health: { organs: ["ì „ë°˜ì  ê´€ë¦¬"], activities: ["ì¢…í•© ê²€ì§„"] }
        }
    };

    const myAdv = ADVICE_DB[domEl] || ADVICE_DB['Unknown'];
    const weakAdv = ADVICE_DB[weakEl] || ADVICE_DB['Unknown'];

    // 7. Saju Brain (Backend Intelligence)
    // const soulmate = SajuBrain.findSoulmate(sajuData); // Unused for now

    const dayEl = pillars.day.stemElement;
    const elColorKey = dayEl === 'Wood' ? 'ëª©' : dayEl === 'Fire' ? 'í™”' : dayEl === 'Earth' ? 'í† ' : dayEl === 'Metal' ? 'ê¸ˆ' : dayEl === 'Water' ? 'ìˆ˜' : dayEl;

    // Day Master
    const dmHanja = data.fourPillars.day.heavenlyStem;
    const dmVal = data.dayMaster as any;
    const dmName = typeof dmVal === 'string'
        ? dmVal.split('(')[0]
        : dmVal?.name || "ì¼ê°„";

    return {
        pillars,
        elementBalance: counts,
        dayMaster: { name: dmName, hanja: dmHanja, element: elColorKey },
        keywords: data.interpretation.personalityKeywords || ["ê°•ì¸í•œ ì˜ì§€", "ìƒˆë¡œìš´ ì‹œì‘"],
        summary: data.interpretation.dominanceMsg || "ìš´ëª…ì˜ íë¦„ì´ ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.",
        lucky: {
            color: lucky.color,
            hex: lucky.hex,
            number: lucky.number,
            direction: lucky.direction
        },
        animal: "ë ",
        score: 85,
        fortune: {
            overall: {
                score: 85,
                title: "ë‹¹ì‹ ì˜ íƒ€ê³ ë‚œ ê¸°ìš´",
                detail: `${data.interpretation.dominanceMsg} íŠ¹íˆ ${myAdv.career.desc}`
            },
            career: {
                score: 75 + Math.floor(Math.random() * 20),
                title: myAdv.career.title,
                dos: myAdv.career.keywords,
                donts: ["ê³¼ë„í•œ ê³ ì§‘", "ì„±ê¸‰í•œ ê²°ì •"]
            },
            love: {
                score: 70 + Math.floor(Math.random() * 20),
                title: "ì• ì •ìš´",
                idealMatch: `ë‚˜ì˜ ë¶€ì¡±í•œ ${data.fiveElements?.lacking} ê¸°ìš´ì„ ì±„ì›Œì£¼ëŠ” ì‚¬ëŒ`
            },
            health: {
                score: 60 + Math.floor(Math.random() * 30),
                title: "ê±´ê°• ê´€ë¦¬",
                organs: weakAdv.health.organs,
                activities: weakAdv.health.activities
            },
        },
        rawData: sajuData // Return raw engine data for ShareCard / NFT
    };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë©”ì¸ App
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
export default function SajuAppV3() {
    const router = useRouter();
    const { setSajuData, addToHistory, user } = useSajuStore();
    const { connection } = useConnection();
    const wallet = useWallet();

    const [view, setView] = useState("input"); // "input" | "result"
    const [form, setForm] = useState({
        year: 1990, month: 1, day: 1,
        calendar: "solar", gender: null as string | null, sijin: null as string | null, region: "",
    });
    const [sheet, setSheet] = useState<"year" | "month" | "day" | null>(null);
    const [result, setResult] = useState<any>(null);
    const [fade, setFade] = useState(false);
    const shareRef = useRef<HTMLDivElement>(null);
    const [isSharing, setIsSharing] = useState(false);
    const [isMinting, setIsMinting] = useState(false);

    // Compliance State (Suhyun Request)
    const [agreed, setAgreed] = useState(false);

    const isValid = form.gender !== null && form.sijin !== null && agreed;
    const missing = [];
    if (!form.gender) missing.push("ì„±ë³„");
    if (!form.sijin) missing.push("íƒœì–´ë‚œ ì‹œê°„");
    if (!agreed) missing.push("ì•½ê´€ ë™ì˜");

    const navigate = useCallback((to: string, res?: any) => {
        setFade(true);
        setTimeout(() => {
            if (res) setResult(res);
            setView(to);
            window.scrollTo(0, 0);
            setTimeout(() => setFade(false), 50);
        }, 200);
    }, []);

    const handleSubmit = () => {
        if (!isValid) return;
        // CALL REAL ENGINE ADAPTER
        const res = calcSajuReal(form.year, form.month, form.day, form.sijin, form.gender || 'male');

        // Update Global Store for Chat/Share
        if (res.rawData) {
            setSajuData(res.rawData);
            addToHistory(res.rawData as any); // Save to local history
        }

        navigate("result", res);
    };

    const handleShare = async () => {
        if (!shareRef.current || !result?.rawData) return;
        setIsSharing(true);
        try {
            await new Promise(r => setTimeout(r, 100)); // Wait for render
            const canvas = await html2canvas(shareRef.current, {
                scale: 1, // ShareCard is already high res (1080px wide)
                useCORS: true,
                backgroundColor: '#000'
            });
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `saju-card-${form.year}${form.month}${form.day}.png`;
            a.click();
        } catch (e) {
            console.error(e);
            alert("ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } finally {
            setIsSharing(false);
        }
    };

    const handleMint = async () => {
        if (!shareRef.current || !result?.rawData) return;
        if (!wallet.connected || !wallet.publicKey) {
            alert("ì§€ê°‘ì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒë‹¨ ì§€ê°‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            return;
        }

        setIsMinting(true);
        try {
            await new Promise(r => setTimeout(r, 100));
            // 1. Generate Image
            const canvas = await html2canvas(shareRef.current, {
                scale: 1,
                useCORS: true,
                backgroundColor: '#000'
            });
            const imageDatasUri = canvas.toDataURL('image/png');

            // 2. Construct Metadata
            const metadata = {
                name: `SajuChain Fortune #${form.year}${form.month}${form.day}`,
                symbol: "SAJU",
                description: `Your Destiny Analysis for ${form.year}-${form.month}-${form.day}. Preserved on-chain by SajuChain.`,
                image: "image.png",
                external_url: "https://sajuchain.com",
                attributes: [
                    { trait_type: "Day Master", value: result.dayMaster.hanja },
                    { trait_type: "Dominant Element", value: result.lucky.color }
                ],
                properties: {
                    category: "image" as const,
                    creators: [{ address: wallet.publicKey.toString(), share: 100 }],
                    files: []
                }
            };

            // 3. Call Mint Logic
            const mintResult = await mintSajuNFT(connection, wallet, metadata, imageDatasUri);
            console.log("Minted:", mintResult);
            alert(`NFT ë¯¼íŒ…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nMint Address: ${mintResult.mintAddress.slice(0, 8)}...`);

        } catch (e) {
            console.error(e);
            alert("NFT ë¯¼íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            setIsMinting(false);
        }
    };

    /* â•â•â• Render â•â•â• */
    return (
        <div style={{
            fontFamily: "'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",
            background: "#09090b", minHeight: "100vh",
            opacity: fade ? 0 : 1, transition: "opacity 0.2s ease",
            overflowX: "hidden"
        }}>
            {/* Hidden Share Card */}
            <div style={{ position: "fixed", left: "-9999px", top: 0 }}>
                {result?.rawData && (
                    <ShareCard
                        ref={shareRef}
                        data={result.rawData}
                        type="saju"
                        theme="mystic"
                    />
                )}
            </div>

            <style>{`
        *{box-sizing:border-box;margin:0;padding:0}
        body{background:#09090b;margin:0}
        ::-webkit-scrollbar{width:0;display:none}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .wallet-adapter-button { height: 32px !important; padding: 0 12px !important; font-size: 11px !important; background: #27272a !important; border: 1px solid rgba(255,255,255,0.06) !important; border-radius: 16px !important; color: #a1a1aa !important; font-family: inherit !important; }
        .wallet-adapter-button:not([disabled]):hover { background: #3f3f46 !important; }
       `}</style>

            {view === "result" && result ? (
                <ResultPage
                    form={form}
                    result={result}
                    onBack={() => navigate("input")}
                    router={router}
                    onShare={handleShare}
                    isSharing={isSharing}
                    onMint={handleMint}
                    isMinting={isMinting}
                />
            ) : (
                /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   ì…ë ¥ í™”ë©´
                   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
                <div style={{ maxWidth: 480, margin: "0 auto", padding: "0 20px", position: "relative" }}>
                    {/* ë°°ê²½ ê¸€ë¡œìš° */}
                    <div style={{
                        position: "fixed", top: 0, left: 0, right: 0, height: 250,
                        background: "radial-gradient(ellipse at 50% 0%,rgba(168,85,247,0.06) 0%,transparent 70%)",
                        pointerEvents: "none", zIndex: 0
                    }} />

                    {/* í—¤ë” */}
                    <div style={{
                        display: "flex", justifyContent: "space-between", alignItems: "center",
                        padding: "14px 0", position: "relative", zIndex: 1,
                    }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            <span style={{ fontSize: 20 }}>ğŸ”®</span>
                            <span style={{
                                fontSize: 17, fontWeight: 800,
                                background: "linear-gradient(135deg,#c084fc,#a78bfa)",
                                WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent",
                            }}>ë””ì§€í„¸ ë„ì‚¬</span>
                        </div>
                        <div style={{
                            display: "flex", alignItems: "center", gap: 8
                        }}>
                            <button onClick={() => router.push('/dojo')} style={{
                                width: 32, height: 32, borderRadius: 16, border: "none", cursor: "pointer",
                                background: user ? "linear-gradient(135deg, #a855f7, #ec4899)" : "#27272a",
                                display: "flex", alignItems: "center", justifyContent: "center",
                                overflow: "hidden"
                            }}>
                                {user?.user_metadata?.avatar_url ? (
                                    <>
                                        {/* eslint-disable-next-line @next/next/no-img-element */}
                                        <img src={user.user_metadata.avatar_url} alt="User" style={{ width: "100%", height: "100%" }} />
                                    </>
                                ) : (
                                    <span style={{ fontSize: 16 }}>{user ? "ğŸ¦„" : "ğŸ‘¤"}</span>
                                )}
                            </button>
                            <WalletMultiButton />
                        </div>
                    </div>

                    {/* â”€â”€ ìƒë…„ì›”ì¼ â”€â”€ */}
                    <section style={{ marginTop: 14, position: "relative", zIndex: 1 }}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                            <span style={{ fontSize: 16, fontWeight: 700 }}>ìƒë…„ì›”ì¼</span>
                            {/* ì–‘ë ¥/ìŒë ¥ í† ê¸€ */}
                            <div style={{ display: "flex", height: 28, background: "#27272a", borderRadius: 14, padding: 2 }}>
                                {["solar", "lunar"].map(c => (
                                    <button key={c} onClick={() => setForm(p => ({ ...p, calendar: c }))}
                                        style={{
                                            height: 24, padding: "0 12px", borderRadius: 12, border: "none", cursor: "pointer",
                                            fontSize: 11, fontWeight: form.calendar === c ? 600 : 400,
                                            background: form.calendar === c ? "#7c3aed" : "transparent",
                                            color: form.calendar === c ? "#fff" : "#71717a",
                                            transition: "all 0.2s",
                                        }}>{c === "solar" ? "â˜€ï¸ ì–‘ë ¥" : "ğŸŒ™ ìŒë ¥"}</button>
                                ))}
                            </div>
                        </div>

                        {/* ë…„/ì›”/ì¼ ì¹´ë“œ */}
                        <div style={{ display: "flex", gap: 8 }}>
                            {[
                                { type: "year", flex: 1.4, label: "ë…„", value: form.year },
                                { type: "month", flex: 1, label: "ì›”", value: form.month },
                                { type: "day", flex: 1, label: "ì¼", value: form.day },
                            ].map((p: any) => (
                                <div key={p.type}
                                    onClick={() => setSheet(p.type)}
                                    style={{
                                        flex: p.flex, height: 68, borderRadius: 14, cursor: "pointer",
                                        background: sheet === p.type ? "rgba(168,85,247,0.08)" : "#27272a",
                                        border: sheet === p.type ? "1.5px solid rgba(168,85,247,0.4)" : "1px solid rgba(255,255,255,0.06)",
                                        padding: "10px 14px",
                                        display: "flex", flexDirection: "column", justifyContent: "space-between",
                                        transition: "all 0.2s",
                                        boxShadow: sheet === p.type ? "0 0 16px rgba(168,85,247,0.1)" : "none",
                                    }}>
                                    <span style={{ fontSize: 10, color: sheet === p.type ? "#a855f7" : "#52525b", fontWeight: 500, transition: "color 0.2s" }}>{p.label}</span>
                                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                        <span style={{ fontSize: 22, fontWeight: 700, color: "#fafafa" }}>{p.value}</span>
                                        <span style={{ fontSize: 12, color: "#52525b", transition: "transform 0.2s", transform: sheet === p.type ? "rotate(180deg)" : "rotate(0)" }}>â–¼</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* â”€â”€ ì„±ë³„ â”€â”€ */}
                    <section style={{ marginTop: 20, position: "relative", zIndex: 1 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 10 }}>
                            <span style={{ fontSize: 16, fontWeight: 700 }}>ì„±ë³„</span>
                            {form.gender && <span style={{ color: "#a855f7", fontSize: 14 }}>âœ“</span>}
                        </div>
                        <div style={{ display: "flex", gap: 8 }}>
                            {[{ k: "male", e: "ğŸ‘¨", l: "ë‚¨ì„±" }, { k: "female", e: "ğŸ‘©", l: "ì—¬ì„±" }].map(g => (
                                <div key={g.k} onClick={() => setForm(p => ({ ...p, gender: g.k }))}
                                    style={{
                                        flex: 1, height: 52, borderRadius: 14, cursor: "pointer",
                                        background: form.gender === g.k ? "rgba(168,85,247,0.1)" : "#27272a",
                                        border: form.gender === g.k ? "1.5px solid rgba(168,85,247,0.4)" : "1px solid rgba(255,255,255,0.06)",
                                        display: "flex", alignItems: "center", justifyContent: "center", gap: 8,
                                        transition: "all 0.2s",
                                        boxShadow: form.gender === g.k ? "0 0 12px rgba(168,85,247,0.08)" : "none",
                                    }}>
                                    {form.gender === g.k && <span style={{ color: "#a855f7", fontSize: 13 }}>âœ“</span>}
                                    <span style={{ fontSize: 18 }}>{g.e}</span>
                                    <span style={{
                                        fontSize: 14, fontWeight: form.gender === g.k ? 600 : 400,
                                        color: form.gender === g.k ? "#fafafa" : "#a1a1aa", transition: "all 0.2s"
                                    }}>{g.l}</span>
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* â”€â”€ íƒœì–´ë‚œ ì‹œê°„ â”€â”€ */}
                    <section style={{ marginTop: 20, position: "relative", zIndex: 1 }}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                                <span style={{ fontSize: 16, fontWeight: 700 }}>íƒœì–´ë‚œ ì‹œê°„</span>
                                {form.sijin && <span style={{ color: "#a855f7", fontSize: 14 }}>âœ“</span>}
                            </div>
                            <span style={{ fontSize: 11, color: "#52525b", fontStyle: "italic" }}>ì •í™•í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”</span>
                        </div>
                        <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 6 }}>
                            {SIJIN.map(s => (
                                <div key={s.key} onClick={() => setForm(p => ({ ...p, sijin: s.key }))}
                                    style={{
                                        height: 50, borderRadius: 11, cursor: "pointer",
                                        background: form.sijin === s.key ? "rgba(168,85,247,0.12)" : "#27272a",
                                        border: form.sijin === s.key ? "1.5px solid rgba(168,85,247,0.4)" : "1px solid rgba(255,255,255,0.06)",
                                        display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 1,
                                        transition: "all 0.15s",
                                        boxShadow: form.sijin === s.key ? "0 0 10px rgba(168,85,247,0.08)" : "none",
                                    }}>
                                    <span style={{ fontSize: 12, fontWeight: 600, color: form.sijin === s.key ? "#fafafa" : "#e4e4e7" }}>{s.name} {s.hanja}</span>
                                    <span style={{ fontSize: 9, color: form.sijin === s.key ? "#a78bfa" : "#52525b" }}>{s.time}</span>
                                </div>
                            ))}
                        </div>
                        {/* ëª¨ë¦„ */}
                        <div onClick={() => setForm(p => ({ ...p, sijin: "unknown" }))}
                            style={{
                                marginTop: 6, height: 40, borderRadius: 11, cursor: "pointer",
                                background: form.sijin === "unknown" ? "rgba(168,85,247,0.12)" : "transparent",
                                border: form.sijin === "unknown" ? "1.5px solid rgba(168,85,247,0.4)" : "1px dashed rgba(255,255,255,0.1)",
                                display: "flex", alignItems: "center", justifyContent: "center",
                                transition: "all 0.15s",
                            }}>
                            <span style={{ fontSize: 12, color: form.sijin === "unknown" ? "#c084fc" : "#52525b" }}>ğŸ¤· ëª¨ë¦„ Â· ì‹œê°„ ë¯¸ìƒ</span>
                        </div>
                    </section>

                    {/* â”€â”€ ì¶œìƒ ì§€ì—­ â”€â”€ */}
                    <section style={{ marginTop: 20, position: "relative", zIndex: 1 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 10 }}>
                            <span style={{ fontSize: 16, fontWeight: 700 }}>ì¶œìƒ ì§€ì—­</span>
                            <span style={{
                                fontSize: 10, color: "#52525b", background: "rgba(255,255,255,0.04)",
                                padding: 2, borderRadius: 4
                            }}>ì„ íƒ</span>
                        </div>
                        <input
                            value={form.region}
                            onChange={e => setForm(p => ({ ...p, region: e.target.value }))}
                            placeholder="ì„œìš¸, ë¶€ì‚°, ëŒ€êµ¬..."
                            style={{
                                width: "100%", height: 48, borderRadius: 14, border: "1px solid rgba(255,255,255,0.06)",
                                background: "#27272a", color: "#fafafa", fontSize: 14, padding: "0 14px",
                                outline: "none",
                            }}
                            onFocus={e => { e.target.style.border = "1.5px solid rgba(168,85,247,0.4)"; e.target.style.boxShadow = "0 0 12px rgba(168,85,247,0.08)" }}
                            onBlur={e => { e.target.style.border = "1px solid rgba(255,255,255,0.06)"; e.target.style.boxShadow = "none" }}
                        />
                        <div style={{ display: "flex", gap: 6, marginTop: 8, overflowX: "auto", paddingBottom: 4 }}>
                            {CITIES.map(c => (
                                <button key={c} onClick={() => setForm(p => ({ ...p, region: c }))}
                                    style={{
                                        height: 30, padding: "0 12px", borderRadius: 15, border: "none", cursor: "pointer",
                                        background: form.region === c ? "rgba(168,85,247,0.12)" : "#27272a",
                                        color: form.region === c ? "#c084fc" : "#71717a",
                                        fontSize: 12, whiteSpace: "nowrap", flexShrink: 0,
                                        transition: "all 0.15s",
                                    }}>{c}</button>
                            ))}
                        </div>
                    </section>

                    {/* â”€â”€ (NEW) ì•½ê´€ ë™ì˜ (Suhyun Request) â”€â”€ */}
                    <section style={{ marginTop: 24, padding: "12px", background: "rgba(255,255,255,0.03)", borderRadius: 12 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 8 }} onClick={() => setAgreed(!agreed)}>
                            <div style={{
                                width: 20, height: 20, borderRadius: 4,
                                border: agreed ? "1px solid #a855f7" : "1px solid #52525b",
                                background: agreed ? "#a855f7" : "transparent",
                                display: "flex", alignItems: "center", justifyContent: "center",
                                cursor: "pointer", transition: "all 0.2s"
                            }}>
                                {agreed && <span style={{ color: "#fff", fontSize: 12 }}>âœ“</span>}
                            </div>
                            <span style={{ fontSize: 12, color: "#a1a1aa", cursor: "pointer" }}>
                                [í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° AI ë¶„ì„ ì´ìš© ë™ì˜
                            </span>
                        </div>
                        <p style={{ fontSize: 10, color: "#52525b", marginTop: 6, lineHeight: 1.4 }}>
                            ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” ì‚¬ì£¼ ë¶„ì„ ë° ê²°ê³¼ ìƒì„±ì„ ìœ„í•´ì„œë§Œ ì‚¬ìš©ë˜ë©°, ì„œë²„ì— ì˜êµ¬ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” AIì— ì˜í•´ ìƒì„±ë˜ë©° ì •í™•ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </p>
                    </section>

                    {/* â”€â”€ CTA â”€â”€ */}
                    <section style={{ marginTop: 16, position: "relative", zIndex: 1 }}>
                        <button onClick={handleSubmit} disabled={!isValid}
                            style={{
                                width: "100%", height: 54, borderRadius: 16, border: "none", cursor: isValid ? "pointer" : "default",
                                background: isValid
                                    ? "linear-gradient(135deg,#7c3aed,#a855f7)"
                                    : "rgba(168,85,247,0.08)",
                                color: isValid ? "#fff" : "rgba(168,85,247,0.35)",
                                fontSize: 16, fontWeight: 700,
                                boxShadow: isValid ? "0 4px 20px rgba(168,85,247,0.3)" : "none",
                                transition: "all 0.2s",
                                ...(isValid ? {
                                    backgroundSize: "200% 100%",
                                    animation: "shimmer 2.5s infinite linear",
                                    backgroundImage: "linear-gradient(90deg,#7c3aed 0%,#a855f7 30%,#c084fc 50%,#a855f7 70%,#7c3aed 100%)",
                                } : {}),
                            }}>
                            âœ¨ ìš´ì„¸ ë³´ê¸°
                        </button>
                        {missing.length > 0 && (
                            <p style={{ textAlign: "center", fontSize: 11, color: "#f59e0b", marginTop: 8 }}>
                                * {missing.join(" Â· ")}ì„(ë¥¼) í™•ì¸í•´ì£¼ì„¸ìš”
                            </p>
                        )}
                    </section>

                    {/* â”€â”€ NFT ë°°ë„ˆ â”€â”€ */}
                    <div style={{
                        marginTop: 12, marginBottom: 32, height: 52, borderRadius: 14,
                        background: "#18181b", border: "1px solid rgba(255,255,255,0.06)",
                        padding: "0 16px", display: "flex", alignItems: "center", cursor: "pointer",
                        position: "relative", zIndex: 1,
                        opacity: 0.7
                    }}>
                        <span style={{ fontSize: 18 }}>ğŸ’</span>
                        <div style={{ marginLeft: 10, flex: 1 }}>
                            <div style={{ fontSize: 13, fontWeight: 600 }}>NFT ì˜êµ¬ ì†Œì¥</div>
                            <div style={{ fontSize: 10, color: "#52525b" }}>ìš´ì„¸ ê²°ê³¼ë¥¼ í™•ì¸ í›„ ë°œí–‰ ê°€ëŠ¥</div>
                        </div>
                    </div>

                    {/* â•â•â• ë°”í…€ì‹œíŠ¸ â•â•â• */}
                    {sheet && (
                        <BottomSheet
                            type={sheet}
                            currentValue={form[sheet as "year" | "month" | "day"]}
                            year={form.year}
                            month={form.month}
                            onConfirm={(val: number) => {
                                setForm(p => {
                                    const next = { ...p, [sheet]: val };
                                    // ì›” ë³€ê²½ ì‹œ ì¼ì ë³´ì •
                                    if (sheet === "month" || sheet === "year") {
                                        const maxD = getDaysInMonth(
                                            sheet === "year" ? val : p.year,
                                            sheet === "month" ? val : p.month
                                        );
                                        if (next.day > maxD) next.day = maxD;
                                    }
                                    return next;
                                });
                                setSheet(null);
                            }}
                            onClose={() => setSheet(null)}
                        />
                    )}
                </div>
            )}
        </div>
    );
}
